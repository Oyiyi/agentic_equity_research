# Database Cache Summary

## Overview

The database cache is a **SQLite database** (`cache.db`) that stores financial data, company information, news, and reports to avoid redundant API calls. It follows a **cache-first strategy**: check database before making API requests.

**Location**: `finrpt/source/cache.db` (default)

---

## 1. Database Initialization

### 1.1 Initialization Trigger

The database is initialized when `Dataer` class is instantiated:

**Location**: `finrpt/source/Dataer.py` (第63-67行)

```python
class Dataer:
    def __init__(self, ...):
        self.database_name = database_name
        self._init_db()  # Initialize all tables
    
    def _init_db(self):
        company_info_table_init(self.database_name)
        company_report_table_init(self.database_name)
        announcement_table_init(self.database_name)
        company_news_table_init(self.database_name)
```

### 1.2 Directory Creation

Each initialization function ensures the database directory exists:

**Location**: `finrpt/source/database_init.py`

```python
def company_info_table_init(db):
    db_path = Path(db)
    db_path.parent.mkdir(parents=True, exist_ok=True)  # Create directory if needed
    conn = sqlite3.connect(str(db))
    # ... create table
```

---

## 2. Table Structures

The database contains **4 main tables**:

### 2.1 `company_info` Table

**Purpose**: Store company basic information

**Primary Key**: `stock_code` (TEXT)

**Columns** (21 fields):
```sql
CREATE TABLE IF NOT EXISTS company_info (
    stock_code TEXT PRIMARY KEY,           -- Stock code (e.g., "600519.SS")
    company_name TEXT,                     -- Company short name
    company_full_name TEXT,                 -- Company full name
    company_name_en TEXT,                  -- English name
    stock_category TEXT,                    -- Stock category
    industry_category TEXT,                 -- Industry category
    stock_exchange TEXT,                    -- Exchange (e.g., "上交所")
    industry_cs TEXT,                       -- Industry classification
    general_manager TEXT,                   -- General manager name
    legal_representative TEXT,              -- Legal representative
    board_secretary TEXT,                   -- Board secretary
    chairman TEXT,                          -- Chairman name
    securities_representative TEXT,         -- Securities representative
    independent_directors TEXT,             -- Independent directors
    website TEXT,                           -- Company website
    address TEXT,                           -- Company address
    registered_capital TEXT,                -- Registered capital
    employees_number TEXT,                  -- Number of employees
    management_number TEXT,                 -- Management number
    company_profile TEXT,                   -- Company profile
    business_scope TEXT                     -- Business scope
)
```

**Column Mapping Constant**: `COMPANY_INFO_TABLE_COLUMNS` (defined in `database_init.py`)

---

### 2.2 `company_report` Table

**Purpose**: Store annual/semi-annual reports

**Primary Key**: `report_id` (TEXT, format: `{stock_code}_{year}_Q{quarter}`)

**Columns** (7 fields):
```sql
CREATE TABLE IF NOT EXISTS company_report (
    report_id TEXT PRIMARY KEY,            -- Format: "600519.SS_2023_Q4"
    content TEXT,                           -- Full report content
    stock_code TEXT,                        -- Stock code
    date TEXT,                              -- Report date
    title TEXT,                             -- Report title
    core_content TEXT,                      -- Extracted core content
    summary TEXT                            -- LLM-generated summary
)
```

**Column Mapping Constant**: `COMPANY_REPORT_TABLE_COLUMNS`

---

### 2.3 `news` Table

**Purpose**: Store news articles with LLM analysis

**Primary Key**: `news_url` (TEXT)

**Columns** (11 fields):
```sql
CREATE TABLE IF NOT EXISTS news (
    news_url TEXT PRIMARY KEY,              -- News article URL
    read_num TEXT,                          -- Read count
    reply_num TEXT,                         -- Reply count
    news_title TEXT,                        -- News title
    news_author TEXT,                       -- Author name
    news_time TEXT,                         -- Publication time
    stock_code TEXT,                        -- Related stock code
    news_content TEXT,                      -- Full news content
    news_summary TEXT,                      -- LLM-generated summary
    dec_response TEXT,                      -- LLM decision response
    news_decision TEXT                      -- Decision: "是" or "否" (affects stock price)
)
```

**Note**: `news_decision` is generated by LLM to determine if the news affects stock price.

---

### 2.4 `announcement` Table

**Purpose**: Store company announcements

**Primary Key**: `url` (TEXT)

**Columns** (5 fields):
```sql
CREATE TABLE IF NOT EXISTS announcement (
    url TEXT PRIMARY KEY,                   -- Announcement URL
    date TEXT,                              -- Announcement date
    title TEXT,                             -- Announcement title
    content TEXT,                           -- Announcement content
    stock_code TEXT                         -- Related stock code
)
```

---

## 3. Data Insertion

### 3.1 Insert Functions

All insert functions are in `finrpt/source/database_insert.py`:

| Function | Table | Usage |
|----------|-------|-------|
| `company_info_table_insert_em()` | `company_info` | Insert company info from EastMoney API |
| `company_report_table_insert()` | `company_report` | Insert report with LLM summary |
| `company_news_table_insert()` | `news` | Insert news with LLM summary and decision |
| `announcement_table_insert()` | `announcement` | Insert announcement |

### 3.2 Insert Pattern

All insert functions follow this pattern:

```python
def table_insert(db, data):
    try:
        conn = sqlite3.connect(db)
        c = conn.cursor()
        c.execute('''
            INSERT INTO table_name (col1, col2, ...) 
            VALUES (?, ?, ...)
        ''', (data.get('key1'), data.get('key2'), ...))
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        # Handle error
        return False
```

**Note**: Uses parameterized queries (`?`) to prevent SQL injection.

---

## 4. Data Query

### 4.1 Query Functions

Query functions are in `finrpt/source/database_query.py`:

| Function | Purpose |
|----------|---------|
| `company_news_table_query_by_url()` | Query news by URL |
| `announcement_table_query_by_url()` | Query announcement by URL |

### 4.2 Direct Queries in Dataer

`Dataer` class also performs direct SQL queries:

**Company Info** (`Dataer.py` 第113-121行):
```python
c.execute('SELECT * FROM company_info WHERE stock_code = ?', (stock_code,))
```

**Company Report** (`Dataer.py` 第184-208行):
```python
c.execute('SELECT * FROM company_report WHERE report_id = ?', (report_id,))
```

**News** (`Dataer.py` 第531-535行):
```python
c.execute('''SELECT * FROM news 
              WHERE stock_code = ? AND news_time BETWEEN ? AND ?''', 
          (stock_code, start_date, end_date))
```

**Trend** (`FinRpt.py` 第169行):
```python
c.execute(f"SELECT * FROM trend WHERE id='{stock_code}_{date}'")
```

**Note**: The `trend` table is **not** initialized by `Dataer._init_db()`. It may be created elsewhere or manually.

---

## 5. Cache-First Strategy

### 5.1 Workflow

For each data type, `Dataer` follows this pattern:

```
1. Query database
   ↓
2. If found → Return cached data
   ↓
3. If not found → Call API
   ↓
4. Process data (optional LLM analysis)
   ↓
5. Insert into database
   ↓
6. Return data
```

### 5.2 Example: Company Info

**Location**: `Dataer.get_company_info()` (第107-142行)

```python
def get_company_info(self, stock_code, company_name):
    # Step 1: Query database
    conn = sqlite3.connect(self.database_name)
    c.execute('SELECT * FROM company_info WHERE stock_code = ?', (stock_code,))
    result = c.fetchone()
    
    if result:
        # Step 2: Return cached data
        return dict(zip(COMPANY_INFO_TABLE_COLUMNS, result))
    
    # Step 3: Call API
    response = self._request_get(url)
    data = response.json()['result']['data'][0]
    
    # Step 4 & 5: Insert into database
    company_info_table_insert_em(db=self.database_name, data=data, stock_code=stock_code)
    
    # Step 6: Return (recursive call to get from cache)
    return self.get_company_info(stock_code=stock_code_ori)
```

---

## 6. Data Types Stored

| Data Type | Source | Cached? | LLM Processing |
|-----------|--------|---------|-----------------|
| Company Info | EastMoney API | ✅ Yes | ❌ No |
| Financials | `yfinance` / `akshare` | ❌ No | ❌ No |
| News | Sina Finance API | ✅ Yes | ✅ Yes (summary + decision) |
| Reports | EastMoney API | ✅ Yes | ✅ Yes (summary) |
| Announcements | Sina Finance API | ✅ Yes | ❌ No |
| Trend | Database (manual?) | ✅ Yes | ❌ No |

**Note**: Financials are **not cached** (see commented code in `Dataer.get_finacncials_ak()` 第741-756行).

---

## 7. Key Design Decisions

### 7.1 Primary Keys

- **`company_info`**: `stock_code` (one record per stock)
- **`company_report`**: `report_id` (format: `{stock_code}_{year}_Q{quarter}`)
- **`news`**: `news_url` (one record per news article)
- **`announcement`**: `url` (one record per announcement)

### 7.2 LLM-Processed Fields

Some fields are generated by LLM and stored in cache:

- **`news.news_summary`**: LLM-generated summary
- **`news.news_decision`**: LLM decision ("是" or "否")
- **`news.dec_response`**: Full LLM response
- **`company_report.summary`**: LLM-generated report summary

This avoids re-running expensive LLM calls for the same data.

### 7.3 Text Storage

All fields are stored as `TEXT` type, including:
- Dates (as strings: "YYYY-MM-DD")
- Numbers (as strings)
- Large content (reports, news articles)

---

## 8. Database File Location

**Default Path**: `finrpt/source/cache.db`

**Customization**: Can be set when creating `Dataer` or `FinRpt`:

```python
# In FinRpt.__init__()
if database_name is None:
    project_root = Path(__file__).parent.parent.parent
    database_name = project_root / 'finrpt' / 'source' / 'cache.db'

# In Dataer.__init__()
self.database_name = database_name  # Can be custom path
```

---

## 9. Summary

The database cache is defined as:

1. **4 SQLite tables** initialized automatically when `Dataer` is created
2. **Cache-first strategy**: Query database before API calls
3. **LLM results cached**: News summaries and decisions are stored to avoid re-processing
4. **Primary keys**: Each table has a unique identifier (stock_code, report_id, news_url, url)
5. **Text-based storage**: All data stored as TEXT for flexibility
6. **Directory auto-creation**: Database directory is created if it doesn't exist

This design reduces API calls, speeds up data retrieval, and enables offline testing with pre-populated data.
